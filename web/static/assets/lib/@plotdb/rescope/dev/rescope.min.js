(function(){function n(e,n){var t={}.hasOwnProperty;for(var o in n)t.call(n,o)&&(e[o]=n[o]);return e}function o(e,n){for(var t=-1,o=n.length>>>0;++t<o;)if(e===n[t])return!0;return!1}var r,i,a;r=function(n,o){return fetch(n,o).then(function(n){return n?n.ok?n.text():(n.clone().text().then(function(e){var n;try{if((n=JSON.parse(e))&&"lderror"===n.name)return n}catch(e){return e}}),{s:n.status,t:t,e:e}):Promise.resolve({s:404,t:"unknown"})}).then(function(e){var n,o;return"string"==typeof e?e:(o=new Error(e.s+" "+e.t),o.name="lderror",o.id=e.s,o.message=t,n=o,e.e&&((n.e=e.e,n).json=e.e),Promise.reject(n))})},(i=function(e){return null==e&&(e={}),this.opt=n({inFrame:!1},e),this.inFrame=!!this.opt.inFrame,this.prejs=e.prejs||[],this.global=e.global||("undefined"!=typeof global&&null!==global?global:window),e.registry&&this.registry(e.registry),this.scope={},this}).func=[],i.lock={frame:{queue:[],busy:!1},local:{queue:[],busy:!1}},i._cache={},i.cache=function(e,n){return null==n&&(n={code:"",vars:[]}),i._cache[e]=n},i.cacheDump=function(){var e;return console.log(e="(function(){\n  var _libs = "+JSON.stringify(i._cache)+";\n  for(k in _libs) { rescope.cache(k,_libs[k]); }\n})();"),e},a={deprecated:["webkitStorageInfo"],attr:["applicationCache","caches","closed","console","controllers","crossOriginIsolated","crypto","customElements","defaultStatus","devicePixelRatio","dialogArguments","directories","document","event","frameElement","frames","fullScreen","history","indexedDB","innerHeight","innerWidth","isSecureContext","isSecureContext","length","localStorage","location","locationbar","menubar","mozAnimationStartTime","mozInnerScreenX","mozInnerScreenY","mozPaintCount","name","navigator","onabort","onafterprint","onanimationcancel","onanimationend","onanimationiteration","onappinstalled","onauxclick","onbeforeinstallprompt","onbeforeprint","onbeforeunload","onblur","oncancel","oncanplay","oncanplaythrough","onchange","onclick","onclose","oncontextmenu","oncuechange","ondblclick","ondevicemotion","ondeviceorientation","ondeviceorientationabsolute","ondragdrop","ondurationchange","onended","onerror","onfocus","onformdata","ongamepadconnected","ongamepaddisconnected","ongotpointercapture","onhashchange","oninput","oninvalid","onkeydown","onkeypress","onkeyup","onlanguagechange","onload","onloadeddata","onloadedmetadata","onloadend","onloadstart","onlostpointercapture","onmessage","onmessageerror","onmousedown","onmouseenter","onmouseleave","onmousemove","onmouseout","onmouseover","onmouseup","onmozbeforepaint","onpaint","onpause","onplay","onplaying","onpointercancel","onpointerdown","onpointerenter","onpointerleave","onpointermove","onpointerout","onpointerover","onpointerup","onpopstate","onrejectionhandled","onreset","onresize","onscroll","onselect","onselectionchange","onselectstart","onstorage","onsubmit","ontouchcancel","ontouchstart","ontransitioncancel","ontransitionend","onunhandledrejection","onunload","onvrdisplayactivate","onvrdisplayblur","onvrdisplayconnect","onvrdisplaydeactivate","onvrdisplaydisconnect","onvrdisplayfocus","onvrdisplaypointerrestricted","onvrdisplaypointerunrestricted","onvrdisplaypresentchange","onwheel","opener","origin","outerHeight","outerWidth","pageXOffset","pageYOffset","parent","performance","personalbar","pkcs11","screen","screenLeft","screenTop","screenX","screenY","scrollbars","scrollMaxX","scrollMaxY","scrollX","scrollY","self","sessionStorage","sidebar","speechSynthesis","status","statusbar","toolbar","top","visualViewport","window","Methods","alert","atob","back","blur","btoa","cancelAnimationFrame","cancelIdleCallback","captureEvents","clearImmediate","clearInterval","clearTimeout","close","confirm","convertPointFromNodeToPage","convertPointFromPageToNode","createImageBitmap","dump","fetch","find","focus","forward","getComputedStyle","getDefaultComputedStyle","getSelection","home","matchMedia","minimize","moveBy","moveTo","open","openDialog","postMessage","print","prompt","queueMicrotask","releaseEvents","requestAnimationFrame","requestFileSystem","requestIdleCallback","resizeBy","resizeTo","routeEvent","scroll","scrollBy","scrollByLines","scrollByPages","scrollTo","setCursor","setImmediate","setInterval","setTimeout","showDirectoryPicker","showModalDialog","showOpenFilePicker","showSaveFilePicker","sizeToContent","stop","updateCommands","Events","event","afterprint","animationcancel","animationend","animationiteration","beforeprint","beforeunload","blur","copy","cut","DOMContentLoaded","error","focus","hashchange","languagechange","load","message","messageerror","offline","online","orientationchange","pagehide","pageshow","paste","popstate","rejectionhandled","storage","transitioncancel","unhandledrejection","unload","vrdisplayconnect","vrdisplaydisconnect","vrdisplaypresentchange"],dom:["Attr","CDATASection","CharacterData","ChildNode","Comment","CustomEvent","Document","DocumentFragment","DocumentType","DOMError","DOMException","DOMImplementation","DOMString","DOMTimeStamp","DOMStringList","DOMTokenList","Element","Event","EventTarget","HTMLCollection","MutationObserver","MutationRecord","NamedNodeMap","Node","NodeFilter","NodeIterator","NodeList","ProcessingInstruction","Selection","Range","Text","TextDecoder","TextEncoder","TimeRanges","TreeWalker","URL","Window","Worker","XMLDocument"]},i.prototype=n(Object.create(Object.prototype),{_reg:function(e){var n,t,o;return n=e.name,t=e.version,o=e.path,"/assets/lib/"+n+"/"+(t||"latest")+"/"+(o||"")},registry:function(e){var n;if(this._reg=e||"","string"==typeof this._reg&&this._reg&&"/"!==(n=this._reg)[n.length-1]&&(this._reg+="/"),!this.inFrame)return this.iframe&&(this.iframe.registry=this._reg,this.iframe._scope)?this.iframe._scope.registry(this._reg):void 0},getUrl:function(e){return null!=e.url?e.url:null!=e.name?"function"==typeof this._reg?this._reg({name:e.name,version:e.version,path:e.path}):this._reg+"/"+name+"/"+(version||"latest")+"/"+(path||""):e},peekScope:function(){return console.log("in delegate iframe: "+!!this.global._rescopeDelegate),this.global._rescopeDelegate},init:function(){var e=this;return this.inFrame?Promise.resolve():(this.prejs.map(function(e){var n;return(n=document.createElement("script")).setAttribute("type","text/javascript"),n.setAttribute("src",e),document.body.appendChild(n)}),new Promise(function(t,r){var s,c,l;return(s=document.createElement("iframe")).setAttribute("title","rescope script loader"),s.setAttribute("name","delegator-"+Math.random().toString(36).substring(2)),s.setAttribute("sandbox","allow-same-origin allow-scripts"),n(s.style,{opacity:0,zIndex:-1,pointerEvents:"none",top:"0px",left:"0px",width:"0px",height:"0px",position:"absolute"}),c=e.prejs.map(function(e){return'<script type="text/javascript" src="'+e+'"><\/script>'}).join(""),l='<html><head><meta http-equiv="Content-type" content="text/html;charset=UTF-8"></head><body>\n'+c+"\n<script>\nfunction init() {\n  if(!window._scope) { window._scope = new rescope({inFrame:true,global:window,registry:window._reg}) }\n}\nfunction load(url,ctx) { return _scope.load(url,ctx); }\nfunction context(url,func) { _scope.context(url,func,true); }\n<\/script></body></html>",s.onerror=function(e){return r(e)},s.onload=function(){var n,r;return n=e.iframe=s.contentWindow,n.rescope=i,n._rescopeDelegate=!0,n._reg=e._reg,e.iframe.init(),e.frameScope=e.iframe._scope.scope,a.all=Array.from(new Set(function(){var e=[];for(r in this.iframe)e.push(r);return e}.call(e).concat(a.dom,a.attr))).filter(function(e){return!o(e,a.deprecated)}),t()},s.src=URL.createObjectURL(new Blob([l],{type:"text/html"})),document.body.appendChild(s)}))},context:function(e,n,t){return null==t&&(t=!1),"string"==typeof e||Array.isArray(e)?this.ctxFromUrl(e,n,t):this.ctxFromObj(e,n,t)},ctxFromObj:function(e,n,t){var o,r,i,a=this;if(null==e&&(e={}),null==t&&(t=!1),o={},this.inFrame)for(r in e)o[r]=this.global[r],this.global[r]=e[r];return i=n(e),(t&&i&&i.then?i:Promise.resolve()).then(function(){var e,n=[];if(a.inFrame){for(e in o)n.push(a.global[e]=o[e]);return n}})},ctxFromUrl:function(e,n,t){var o,r,i,a,s,c,l,u,p,d,m,f=this;for(null==t&&(t=!1),e=Array.isArray(e)?e:[e],o=[],r=[],i={},a=0,s=e.length;a<s;++a){c=a,u=(l=[{},this.scope[e[c].url||e[c]]||{}])[0],p=l[1];for(d in p)u[d]=this.global[d],this.global[d]=p[d],i[d]=p[d];o.push(u),r.push(p)}return m=n(i),(t&&m&&m.then?m:Promise.resolve()).then(function(){var e,n,t,i,a,s,c=[];for(e=r.length-1;e>=0;--e){t=[],i=r[n=e],a=o[n];for(s in i)t.push(f.global[s]=a[s]);c.push(t)}return c})},load:function(e,t){var o,r,a,s=this;return null==t&&(t={}),e?(t.local||(t.local={}),t.frame||(t.frame={}),o=this.inFrame?"frame":"local",e=Array.isArray(e)?e:[e],r=function(){return Promise.resolve().then(function(){if(!s.inFrame)return s.iframe.load(e,t)}).then(function(){var r;return(r=function(e,t,i){var a,c,l,u;if(null==t&&(t=0),t>=e.length)return Promise.resolve(i);for(a=[],c=t,l=e.length;c<l&&(u=c,a.push(e[u]),null==e[u].async||e[u].async);++c);return a.length?Promise.all(a.map(function(e){var n;return n=s.getUrl(e),s._load(n,i,(s.frameScope||(s.frameScope={}))[n])})).then(function(){return s.context(a.map(function(e){return s.getUrl(e)}),function(s){return n(i[o],s),r(e,t+a.length,i)},!0)}):Promise.resolve(i)})(e,0,t)}).then(function(){})},t?(a=i.lock[o],Promise.resolve().then(function(){if(a.busy)return new Promise(function(e,n){return a.queue.push({res:e,rej:n})})}).then(function(){return a.busy=!0,new Promise(function(e,n){return s.context(t[o],function(){return r().then(function(n){return e(n)}).catch(function(e){return n(e)})},!0)})}).finally(function(){var e;if(a.busy=!1,e=a.queue.splice(0,1)[0])return e.res()})):r()):Promise.resolve()},_wrapper:function(e,t,o,r){var s=this;return null==o&&(o={}),null==r&&(r={}),new Promise(function(c,l){var u,p,d,m,f,h,g,v,b;u=function(){var e,n=[];for(p in e=o)d=e[p],n.push("var "+p+" = context."+p+";this."+p+" = context."+p+";");return n}().join("\n")+"\n",m=function(){var e,n=[];for(p in e=r)d=e[p],n.push("if(typeof("+p+") != 'undefined') { this."+p+" = "+p+"; }");return n}().join("\n")+"\n",u+="var "+(f="_tmp"+Math.random().toString(36).substring(2))+" = {};";for(p in h=r)d=h[p],!o[p]&&r[p]&&(u+=f+"."+p+" = win."+p+"; win."+p+" = undefined;\n",m+="win."+p+" = "+f+"."+p+";\n");return g='/* intercept these variables so lib will inject anything into our scope */\nvar global = this;\nvar globalThis = this;\nvar self = this;\nvar window = this;\n/* yet we need window memebers so lib can work properly with builtin features */\nwindow.__proto__ = win;\n/* some props are not enumerable, so we list all of them directly in winProps.all */\nfor(var i = 0; i < winProps.all.length; i++) {\n  k = winProps.all[i];\n  /* but functions need window as `this` to be called. we indirectly do this for them. */\n  if(typeof(win[k]) == "function") {\n    track.push(k);\n    window[k] = (function(k){ return function() { return win[k].apply(win,arguments);} })(k);\n  } else {\n    /* and some members are from getter/setter. we proxy it via custom getter / setter object. */\n    desc = Object.getOwnPropertyDescriptor(win,k);\n    if(desc && desc.get) {\n      track.push(k);\n      Object.defineProperty(window, k, (function(n,desc) {\n        var ret = {\n          configurable: desc.configurable,\n          enumerable: desc.enumerable\n        };\n        if(desc.get) { ret.get = function() { return win[n]; } }\n        if(desc.set) { ret.set = function(it) { win[n] = it; } }\n        return ret;\n      }(k,desc)));\n    }\n  }\n}',v="x"+Math.random().toString(36).substring(2),u="/* URL: "+e+" */\nrescope.func."+v+" = function(context, winProps) {\n  var win = window;\n  var track = [];\n  var ret = (function() {\n    "+u+"\n    "+g+"\n    "+t+"\n    "+m+"\n    return this;\n  }).apply({});\n  /* returned ret may contain members from window through __proto__.  */\n  /* we only need members from libs, so just ignore those from window object. */\n  for(k in ret) {\n    if((track.indexOf(k) == -1) && ret.hasOwnProperty(k)) { context[k] = ret[k]; }\n  }\n  return context;\n}",b=s.global.document.createElement("script"),b.onerror=function(e){return l(e)},b.onload=function(){return(s.func||(s.func={}))[e]=i.func[v],c(n({},(s.func||(s.func={}))[e](o,a)))},b.setAttribute("src",URL.createObjectURL(new Blob([u],{type:"text/javascript"}))),s.global.document.body.appendChild(b)})},_load:function(e,n,t){var o=this;return null==t&&(t={}),this.inFrame?this._loadInFrame(e):(i._cache[e]?Promise.resolve(i._cache[e].code):r(e,{method:"GET"})).then(function(r){var a;return i._cache[e]={code:r,vars:function(){var e=[];for(a in t)e.push(a);return e}()},o._wrapper(e,r,n.local,t)}).then(function(n){return o.scope[e]=n})},_loadInFrame:function(e){var n=this;return new Promise(function(t,r){var s,c,l,u,p,d;if(s=i._cache[e])return c={},(s.vars||(s.vars=[])).map(function(){return c[p]=!0}),t(c);l=n.global.document.createElement("script"),u={};for(p in n.global)o(p,a.deprecated)||(u[p]=n.global[p]);return l.onerror=function(e){return r(e)},l.onload=function(){var r,i;if(n.scope[e]){r=n.scope[e];for(i in r)r[i],r[i]=n.global[i],n.global[i]=u[i]}else{n.scope[e]=r={};for(i in n.global)o(i,a.deprecated)||null==u[i]&&null!=n.global[i]&&(r[i]=n.global[i],n.global[i]=u[i])}return t(r)},d=/(https?:)?\/\//.exec(e)?e:window.location.origin+("/"===e[0]?"":"/")+e,l.setAttribute("src",d),n.global.document.body.appendChild(l)})}}),"undefined"!=typeof module&&null!==module&&(module.exports=i),"undefined"!=typeof window&&null!==window&&(window.rescope=i)}).call(this);
