(()=>{var p,c,a,h,e,d;function m(e,t){var n,r={}.hasOwnProperty;for(n in t)r.call(t,n)&&(e[n]=t[n]);return e}function v(e,t){for(var n=-1,r=t.length>>>0;++n<r;)if(e===t[n])return 1}a=function(e,t){return d.__node&&"undefined"!=typeof fs&&null!==fs&&!/^https?:/.exec(e)?new Promise(function(n,r){return fs.readFile(e,function(e,t){return e?r(e):n(t.toString())})}):fetch(e,t).then(function(i){var e;return i&&i.ok?i.text():i?i.clone().text().then(function(e){var t,n=i.status||404,r=new Error(n+" "+e);r.name="lderror",r.id=n,r.message=e,n=r;try{(t=JSON.parse(e))&&"lderror"===t.name&&(m(n,t).json=t)}catch(e){0}return Promise.reject(n)}):Promise.reject(((e=new Error("404")).name="lderror",e.id=404,e))})},(h=function(e){var t,n,i,o,r,s=this;return this.lc=(e=null==e?{}:e).context||{},this.id=Math.random().toString(36).substring(2),e.iframe?this.iframe=e.iframe:(this.iframe=t=c.createElement("iframe"),(n=t.style).position="absolute",n.top=0,n.left=0,n.width=0,n.height=0,n.pointerEvents="none",n.opacity=0,t.setAttribute("title","rescope script loader"),t.setAttribute("name","pdb-proxin-"+this.id),c.body.appendChild(t)),i=Object.fromEntries(Reflect.ownKeys(this.iframe.contentWindow).map(function(e){return[e,!0]})),o={},this._proxy=new Proxy(e.target||p,{get:function(e,t,n){var r;return null!=s.lc[t]?s.lc[t]:null!=o[t]?o[t]:"function"==typeof e[t]?(r=Reflect.get(e,t,n),o[t]=new Proxy(r.bind(e),{get:function(e,t,n){return Reflect.get(v(t,e)?e:r,t,n)}})):null!=i[t]?e[t]:void 0},set:function(e,t,n){return"_rspvarsetcb_"===t?r.on(n.k,n.f):(r.fire(t,n),i[t]?e[t]=n:s.lc[t]=n),!0},defineProperty:function(e,t,n){return Object.defineProperty(s.lc,t,n),s._proxy}}),r={evthdr:{},on:function(e,n){var r=this;return(Array.isArray(e)?e:[e]).map(function(e){var t;return((t=r.evthdr)[e]||(t[e]=[])).push(n)})},fire:function(e){for(var t,n,r,i,o=[],s=[],c=1,u=arguments.length;c<u;++c)s.push(arguments[c]);for(t=s,c=0,r=(n=this.evthdr[e]||[]).length;c<r;++c)i=n[c],o.push(i.apply(this,t));return o}},this}).prototype=((e=Object.create(Object.prototype)).proxy=function(){return this._proxy},e.ctx=function(){return this.lc},e),(d=function(e){var t,n;return null==e&&(e={}),this.id=Math.random().toString(36).substring(2),this.iframe=t=c.createElement("iframe"),this._cache={},this.proxy=new h,this.registry(e.registry||"/assets/lib/"),(n=t.style).position="absolute",n.top=0,n.left=0,n.width=0,n.height=0,n.pointerEvents="none",n.opacity=0,t.setAttribute("title","rescope script loader"),t.setAttribute("name","pdb-rescope-"+this.id),c.body.appendChild(t),t.contentWindow.document.body.innerHTML=(e.preloads||[]).map(function(e){return'<script type="text/javascript" src="'+e+'"><\/script>'}).join(""),this}).env=function(e){e=[e,e.document];return p=e[0],c=e[1],e},d.prop={legacy:{webkitStorageInfo:!0}},d.id=function(e){var t=e.path||("js"===e.type?"index.min.js":"css"===e.type?"index.min.css":"index.html");return e.id||e.url||(e.ns?e.ns+":":"")+e.name+"@"+(e.version||"main")+":"+t},d._cache={},d._ver={map:{},list:{}},d.cache=function(e){var t,n,r,i,o,s,c,u,f,l,p;if((e="string"==typeof e?{url:e}:e).id||(e.id=d.id(e)),t=this._cache[e.id])return t;if(e.id&&!e.name?((o=e.id.split(":")).length<=2?(n=o[0],r=o[1],i=o[2]):(i=o[0],n=o[1],r=o[2]),s=(o=(o=/^(@?[^@]+)(?:@([^:]+))?$/.exec(n))||["",e.id,""])[1],c=o[2]):(i=(u=[e.ns,e.name,e.version||"",e.path||""])[0],s=u[1],c=u[2],r=u[3]),/^[0-9.]+$/.exec(c)){if((t=((u=this._ver.map)[s]||(u[s]={}))[c])&&(c=t),t=this._cache[d.id({ns:i,name:s,version:c,path:r})])return t;for(f=0,l=((u=this._ver.list)[s]||(u[s]=[])).length;f<l;++f)if(p=f,p=this._ver.list[s][p],semver.fit(p,c)&&(this._ver.map[s][c]=p,e.id=d.id({ns:i,name:s,version:p,path:r}),t=this._cache[e.id]))return t}return v(c,(u=this._ver.list)[s]||(u[s]=[]))||this._ver.list[s].push(c),this._cache[e.id]=e},d.prototype=((e=Object.create(Object.prototype)).peekScope=function(){return!1},e.init=function(){return Promise.resolve()},e._ref=function(e){var t,n;return"string"==typeof e&&(e={url:e}),"function"==typeof(t=this._reg.url||this._reg)&&((n=m({},e)).url=t(e),e=n),this._reg.fetch?this._reg.fetch(e):e.url},e.registry=function(e){return"string"==typeof e?("/"===e[e.length-1]&&(e=e.substring(0,e.length-1)),this._reg=(t=e,function(e){return t+"/"+e.name+"/"+(e.version||"main")+"/"+(e.path||"index.min.js")})):this._reg=e;var t},e.cache=function(e){var t;return(e="string"==typeof e?{url:e}:e).id||(e.id=d.id(e)),(t=this._cache[e.id])||(this._cache[e.id]=d.cache(e))},e.exports=function(e){var t,n,r=[],i=(e=null==e?{}:e).ctx||{},e="string"==typeof e.libs?[e.libs]:e.libs||[],o=(t=[{},this.iframe.contentWindow])[0],s=t[1];for(n in i)o[n]=s[n],s[n]=i[n];for(n in this._exports(e,0,i),o)r.push(s[n]=o[n]);return r},e._exports=function(e,t,n){var r,i,o,s,c,u,f=[];if(null==n&&(n={}),r=e[t=null==t?0:t]){if(i=(u=[{},(r=this.cache(r)).fprop,this.iframe.contentWindow])[0],o=u[1],s=u[2],o)for(c in o)i[c]=s[c],s[c]=o[c];else if(r.fprop=o={},r.prop={},r.propIniting=!0,r.gen)m(o,r.gen.apply(s,[s,s,s])),r.prop=Object.fromEntries((()=>{var e=[];for(c in o)e.push([c,null]);return e})());else{for(c in Object.fromEntries(Reflect.ownKeys(s).filter(function(e){return!d.prop.legacy[e]}).map(function(e){return[e,!0]})))i[c]=s[c];try{s.eval((r.code||"").replace('"use strict";',""))}catch(e){throw u=e,console.error("[@plotdb/rescope] Parse failed",{url:r.url,ns:r.ns,name:r.name,version:r.version,path:r.path}),console.error("[@plotdb/rescope] with this error:",u),u}for(c in Object.fromEntries(Reflect.ownKeys(s).filter(function(e){return!d.prop.legacy[e]}).map(function(e){return[e,!0]})))s[c]!==i[c]&&"NaN"!==c&&(o[c]=s[c],r.prop[c]=null)}for(c in o)n[c]=o[c];for(c in this._exports(e,t+1),o)f.push(s[c]=i[c]);return f}},e._wrap=function(e,t,n){var r,i,o,s,c;for(c in null==t&&(t={}),null==n&&(n={}),r=/^[a-zA-Z_$][a-zA-Z0-9_$]*$/,o="var window, global, globalThis, self, __ret = {}; __win = {};\nwindow = global = globalThis = self = window = scope;",s=function(e){return"window['_rspvarsetcb_'] = {k:'"+e+"',f:function(v){"+e+"=v}};"},i=(e=null==e?{}:e).prop||{})r.exec(c)&&(o+="var "+c+";"+s(c)),o+="__win['"+c+"'] = win['"+c+"']; win['"+c+"'] = undefined;";for(c in t)o+="window['"+c+"'] = ctx['"+c+"'];",r.exec(c)&&(o+="var "+c+" = window['"+c+"'];"+s(c));for(c in o+=e.code+";",i)r.exec(c)?o+="if(!("+c+")) { "+c+" = scope['"+c+"']; }\n__ret['"+c+"'] = "+c+" || window['"+c+"'] || win['"+c+"'] || this['"+c+"'];\nwin['"+c+"'] = __win['"+c+"'];":o+="__ret['"+c+"'] = window['"+c+"'] || win['"+c+"'] || this['"+c+"'];\nwin['"+c+"'] = __win['"+c+"'];";return o+="return __ret;",n.codeOnly?"function(scope, ctx, win){"+o+"}":new Function("scope","ctx","win",o)},e.load=function(e,r,i,o){var t,s,c,u,f,l=this;return null==r&&(r={}),null==i&&(i=!1),null==o&&(o=!1),t=(e=(Array.isArray(e)?e:[e]).map(function(e){return l.cache(e)})).px||(e.px=r&&r.p?r.p:new h),s=t.ctx(),c=t.proxy(),u=[e],(f=function(e){var t,n;return(t=u[e=null==e?0:e])?(n=t.map(function(t){var e;return!t.code&&!t.gen||i?(e=l._ref(t)).then?e.then(function(e){return t.code=e.content,l.cache((t.id=void 0,t.version=e.version,t.code=e.content,t))}):a(e,{method:"GET"}).then(function(e){return t.code=e}):Promise.resolve()}),Promise.all(n).then(function(){if(!o)return l.exports({libs:t,ctx:r.f}),t.map(function(e){return e.propIniting&&(e.gen||(e.gen=l._wrap(e,s)),e.prop=e.gen.apply(c,[c,s,p]),e.propIniting=!1),m(s,e.prop)})}).then(function(){return s}).then(function(){return f(e+1)})):Promise.resolve(s)})(0)},e.context=function(e,t,n){var r;return"function"!=typeof t&&(t=(r=[n,t])[0],n=r[1]),this.load(e,n).then(function(e){return t?t(e):e})},e),d.env("undefined"!=typeof self&&null!==self?self:globalThis),d.proxin=h,d.dualContext=function(){return{p:new h,f:{},ctx:function(){return this.p.ctx()}}},"undefined"!=typeof module&&null!==module?module.exports=d:"undefined"!=typeof window&&null!==window&&(window.rescope=d)})();
